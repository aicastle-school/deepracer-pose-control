<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>


    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <!-- chart script -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
    .card-body canvas {
    width: 100%;
    height: auto;
    }
    .controller-result .bar {
    height: 20px;
    border-radius: 4px;
    }
    .progress-text {
    font-size: 0.9rem;
    }

    /* body {
      background: linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)),
                  url('https://images.unsplash.com/photo-1503736334956-4c8f8e92946d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      min-height: 100vh;
    }

    .card {
      background-color: white;
      border-radius: 10px;
    } */

    .progress-bar {
        transition: width 0.3s ease-in-out;
    }
    
  </style>

</head>
<body class="bg-light">

    <div class="container mt-5">
    <div class="row">
      
      <!-- 왼쪽 카드 -->
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <h5 class="card-title font-weight-bold">몸동작으로 차량을 운전!</h5>
                <canvas id='canvas' width="100%" height="200"></canvas>
            
            <h6 class="mt-3">차량 조종 결과</h6>
            <div class="controller-result text-left">

                
              <!-- <div class="mb-2">
                <span class="text-warning font-weight-bold">직진</span>
                <div class="progress">
                  <div class="progress-bar bg-warning" style="width: 20%"></div>
                </div>
              </div>
              <div class="mb-2">
                <span class="text-danger font-weight-bold">좌회전</span>
                <div class="progress">
                  <div class="progress-bar bg-danger" style="width: 100%">100%</div>
                </div>
              </div>
              <div class="mb-2">
                <span class="text-primary font-weight-bold">우회전</span>
                <div class="progress">
                  <div class="progress-bar bg-primary" style="width: 0%"></div>
                </div>
              </div> -->

              
                <div class="mb-2">
                    <span class="text-warning font-weight-bold">빠른 직진</span>
                    <div class="progress">
                        <div id="progress-fast-straight" class="progress-bar bg-warning" style="width: 0%"></div>
                    </div>
                    </div>

                    <div class="mb-2">
                    <span class="text-warning font-weight-bold">느린 직진</span>
                    <div class="progress">
                        <div id="progress-slow-straight" class="progress-bar bg-warning" style="width: 0%"></div>
                    </div>
                    </div>

                    <div class="mb-2">
                    <span class="text-danger font-weight-bold">빠른 좌회전</span>
                    <div class="progress">
                        <div id="progress-fast-left" class="progress-bar bg-danger" style="width: 0%"></div>
                    </div>
                    </div>

                    <div class="mb-2">
                    <span class="text-danger font-weight-bold">느린 좌회전</span>
                    <div class="progress">
                        <div id="progress-slow-left" class="progress-bar bg-danger" style="width: 0%"></div>
                    </div>
                    </div>

                    <div class="mb-2">
                    <span class="text-primary font-weight-bold">빠른 우회전</span>
                    <div class="progress">
                        <div id="progress-fast-right" class="progress-bar bg-primary" style="width: 0%"></div>
                    </div>
                    </div>

                    <div class="mb-2">
                    <span class="text-primary font-weight-bold">느린 우회전</span>
                    <div class="progress">
                        <div id="progress-slow-right" class="progress-bar bg-primary" style="width: 0%"></div>
                    </div>
                </div>

            </div>
          </div>
        </div>
      </div>

      <!-- 오른쪽 카드 -->
      <div class="col-md-8">
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <h4 class="font-weight-bold mb-3">차량 전면 카메라</h4>
            <img src="your_front_camera_view.jpg" alt="차량 전면 화면" class="img-fluid rounded">
          </div>
        </div>
      </div>

    </div>
  </div>



    <div>Teachable Machine Pose Model</div>



<!-- <img src="https://192.168.1.2/route?topic=/camera_pkg/display_mjpeg&width=480&height=360" crossorigin="use-credentials"> -->
<button type='button' onclick='init()'>Start</button>




<div id='label-container'></div>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8.3/dist/teachablemachine-pose.min.js"></script>
<script type="text/javascript">
    // More API functions here:
    // https://github.com/googlecreativelab/teachablemachine-community/tree/master/libraries/pose

    // the link to your model provided by Teachable Machine export panel
    const URL = './';
    let model, webcam, ctx, labelContainer, maxPredictions;

    async function init() {
        const modelURL = URL + '/model.json';
        const metadataURL = URL + '/metadata.json';
        
        // load the model and metadata
        // Refer to tmPose.loadFromFiles() in the API to support files from a file picker
        model = await tmPose.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        // Convenience function to setup a webcam
        const flip = true; // whether to flip the webcam
        webcam = new tmPose.Webcam(200, 200, flip); // width, height, flip
        await webcam.setup(); // request access to the webcam
        webcam.play();
        window.requestAnimationFrame(loop);

        // append/get elements to the DOM
        const canvas = document.getElementById('canvas');
        canvas.width = 200; canvas.height = 200;
        ctx = canvas.getContext('2d');
        labelContainer = document.getElementById('label-container');
        for (let i = 0; i < maxPredictions; i++) { // and class labels
            labelContainer.appendChild(document.createElement('div'));
        }
    }

    async function loop(timestamp) {
        webcam.update(); // update the webcam frame
        await predict();
        window.requestAnimationFrame(loop);
    }

    let lastLogTime = 0; // 마지막으로 로그를 찍은 시간 기록

    async function predict() {
        // Prediction #1: run input through posenet
        // estimatePose can take in an image, video or canvas html element
        const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
        // Prediction 2: run input through teachable machine classification model
        const prediction = await model.predict(posenetOutput);

        // 동작별 확률을 객체로 저장
        const predictionMap = {};

        // for (let i = 0; i < maxPredictions; i++) {
        //     const classPrediction =
        //         prediction[i].className + ': ' + prediction[i].probability.toFixed(2);
        //     labelContainer.childNodes[i].innerHTML = classPrediction;

        //     // prediction[i].className (직진, 좌회전, 우회전) 
        //     // console.log(prediction[i].probability.toFixed(2))
        // }


        const now = Date.now();


        const poseToDriveCommand = {
            "빠른 직진":    { angle: 0.0, speed: 1.0 },
            "느린 직진":    { angle: 0.0, speed: 0.5 },
            "빠른 좌회전":  { angle: -1.0, speed: 1.0 },
            "느린 좌회전":  { angle: -1.0, speed: 0.5 },
            "빠른 우회전":  { angle: 1.0, speed: 1.0 },
            "느린 우회전":  { angle: 1.0, speed: 0.5 }
        };

        if(now - lastLogTime > 1000) {

        // 가장 확률 높은 클래스 선택
        const top = prediction.reduce((prev, current) => (
            prev.probability > current.probability ? prev : current
        ));

           if (top.probability >= 0.8 && poseToDriveCommand[top.className]) {
            const { angle, speed } = poseToDriveCommand[top.className];

            const data = {
                angle: -Math.max(-1, Math.min(1, angle)),
                throttle: -Math.max(-1, Math.min(1, speed)),
                max_speed: speed
            };

            console.log("보내는 데이터:", JSON.stringify(data));

            fetch('https://192.168.1.2/api/manual_drive', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(data)
            })
            .then(res => res.text())  // 응답이 JSON 아닐 수도 있어
            .then(text => {
            console.log("✅ 서버 응답 본문:", text);
            })
            .catch(err => console.error("❌ 오류:", err));
        }    

        for (let i = 0; i < maxPredictions; i++) {
                const label = prediction[i].className;
                const prob = prediction[i].probability;
                predictionMap[label] = prob;

                // UI 표시
                const classPrediction = label + ': ' + prob.toFixed(2);
                labelContainer.childNodes[i].innerHTML = classPrediction;

                // console.log("🔍 예측 결과:", predictionMap);

                // 예: 확률이 0.8 이상일 때만 동작 처리
                if (prob >= 0.5) {
                    switch (label) {
                        case "빠른 직진":
                            console.log("🚀 빠른 직진 감지:", prob.toFixed(2));
                            // 동작 처리 코드
                            break;
                        case "느린 직진":
                            console.log("🚶 느린 직진 감지:", prob.toFixed(2));
                            break;

                        case "빠른 좌회전":
                            console.log("↪️ 빠른 좌회전 감지:", prob.toFixed(2));
                            break;

                        case "느린 좌회전":
                            console.log("↩️ 느린 좌회전 감지:", prob.toFixed(2));
                            break;

                        case "빠른 우회전":
                            console.log("➡️ 빠른 우회전 감지:", prob.toFixed(2));
                            break;

                        case "느린 우회전":
                            console.log("⬅️ 느린 우회전 감지:", prob.toFixed(2));
                            break;

                        default:
                            console.log("🤷 알 수 없는 동작:", label, prob.toFixed(2));
                    }
                }
            }

               lastLogTime = now; // 마지막 로그 시간 갱신
        }

        updateProgressBars(predictionMap);

        // finally draw the poses
        drawPose(pose);

        console.log("🔍 예측값 확인:", predictionMap);

    }

    function drawPose(pose) {
        ctx.drawImage(webcam.canvas, 0, 0);
        // draw the keypoints and skeleton
        if (pose) {
            const minPartConfidence = 0.5;
            tmPose.drawKeypoints(pose.keypoints, minPartConfidence, ctx);
            tmPose.drawSkeleton(pose.keypoints, minPartConfidence, ctx);
        }
    }

    // 실시간 프로그레스바 업데이트
    function updateProgressBars(predictionMap) {
        const mapping = {
            "빠른 직진": "progress-fast-straight",
            "느린 직진": "progress-slow-straight",
            "빠른 좌회전": "progress-fast-left",
            "느린 좌회전": "progress-slow-left",
            "빠른 우회전": "progress-fast-right",
            "느린 우회전": "progress-slow-right"
        };

        for (const [label, id] of Object.entries(mapping)) {
            const value = predictionMap[label] || 0;
            const percent = Math.round(value * 100);

            console.log("퍼센트확인")
            console.log(percent)

            const bar = document.getElementById(id);
            if (bar) {
            bar.style.width = `${percent}%`;
            bar.innerText = percent > 15 ? `${percent}%` : ""; // 너무 좁으면 텍스트 생략
            }
        }
    }

    // const url = 'https://192.168.1.2/route?topic=/camera_pkg/display_mjpeg&width=480&height=360' 
    //     fetch(url, {
    //         method: 'GET',
    //         credentials: 'include',
    //             // headers: {
    //             //     // 'Authorization': 'Bearer YOUR_TOKEN',
    //             //     // 또는 테스트용 쿠키를 강제로 추가해볼 수도 있음 (일시적 디버깅 용도)
    //             //     'Cookie': 'session_id=abc123'
    //             // }
    //     }).then(response => {

    //         console.log("스테이터스 확인")
    //         console.log(response.status)
    //         if (response.ok) {
    //             console.log("성공")
    //             console.log('Stream started successfully');
    //         } else {
    //             console.error('Error starting stream:', response.statusText);
    //             console.log("에러111")
    //         }
    //     }).catch(error => {
    //         console.log("에러222")
    //         console.error('Error:', error);
    //     });

</script>
</body>
</html>