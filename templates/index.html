<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>


    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <!-- chart script -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
    .card-body canvas {
    width: 100%;
    height: auto;
    }
    .controller-result .bar {
    height: 20px;
    border-radius: 4px;
    }
    .progress-text {
    font-size: 0.9rem;
    }

    /* body {
      background: linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)),
                  url('https://images.unsplash.com/photo-1503736334956-4c8f8e92946d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      min-height: 100vh;
    }

    .card {
      background-color: white;
      border-radius: 10px;
    } */

    .progress-bar {
        transition: width 0.3s ease-in-out;
    }
    
  </style>

</head>
<body class="bg-light">

    <div class="container mt-5">
    <div class="row">
      
      <!-- ì™¼ìª½ ì¹´ë“œ -->
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <h5 class="card-title font-weight-bold">ëª¸ë™ì‘ìœ¼ë¡œ ì°¨ëŸ‰ì„ ìš´ì „!</h5>
                <canvas id='canvas' width="100%" height="200"></canvas>
            
            <h6 class="mt-3">ì°¨ëŸ‰ ì¡°ì¢… ê²°ê³¼</h6>
            <div class="controller-result text-left">

                
              <!-- <div class="mb-2">
                <span class="text-warning font-weight-bold">ì§ì§„</span>
                <div class="progress">
                  <div class="progress-bar bg-warning" style="width: 20%"></div>
                </div>
              </div>
              <div class="mb-2">
                <span class="text-danger font-weight-bold">ì¢ŒíšŒì „</span>
                <div class="progress">
                  <div class="progress-bar bg-danger" style="width: 100%">100%</div>
                </div>
              </div>
              <div class="mb-2">
                <span class="text-primary font-weight-bold">ìš°íšŒì „</span>
                <div class="progress">
                  <div class="progress-bar bg-primary" style="width: 0%"></div>
                </div>
              </div> -->

              
                <div class="mb-2">
                    <span class="text-warning font-weight-bold">ë¹ ë¥¸ ì§ì§„</span>
                    <div class="progress">
                        <div id="progress-fast-straight" class="progress-bar bg-warning" style="width: 0%"></div>
                    </div>
                    </div>

                    <div class="mb-2">
                    <span class="text-warning font-weight-bold">ëŠë¦° ì§ì§„</span>
                    <div class="progress">
                        <div id="progress-slow-straight" class="progress-bar bg-warning" style="width: 0%"></div>
                    </div>
                    </div>

                    <div class="mb-2">
                    <span class="text-danger font-weight-bold">ë¹ ë¥¸ ì¢ŒíšŒì „</span>
                    <div class="progress">
                        <div id="progress-fast-left" class="progress-bar bg-danger" style="width: 0%"></div>
                    </div>
                    </div>

                    <div class="mb-2">
                    <span class="text-danger font-weight-bold">ëŠë¦° ì¢ŒíšŒì „</span>
                    <div class="progress">
                        <div id="progress-slow-left" class="progress-bar bg-danger" style="width: 0%"></div>
                    </div>
                    </div>

                    <div class="mb-2">
                    <span class="text-primary font-weight-bold">ë¹ ë¥¸ ìš°íšŒì „</span>
                    <div class="progress">
                        <div id="progress-fast-right" class="progress-bar bg-primary" style="width: 0%"></div>
                    </div>
                    </div>

                    <div class="mb-2">
                    <span class="text-primary font-weight-bold">ëŠë¦° ìš°íšŒì „</span>
                    <div class="progress">
                        <div id="progress-slow-right" class="progress-bar bg-primary" style="width: 0%"></div>
                    </div>
                </div>

            </div>
          </div>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½ ì¹´ë“œ -->
      <div class="col-md-8">
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <h4 class="font-weight-bold mb-3">ì°¨ëŸ‰ ì „ë©´ ì¹´ë©”ë¼</h4>
            <img src="your_front_camera_view.jpg" alt="ì°¨ëŸ‰ ì „ë©´ í™”ë©´" class="img-fluid rounded">
          </div>
        </div>
      </div>

    </div>
  </div>



    <div>Teachable Machine Pose Model</div>



<!-- <img src="https://192.168.1.2/route?topic=/camera_pkg/display_mjpeg&width=480&height=360" crossorigin="use-credentials"> -->
<button type='button' onclick='init()'>Start</button>




<div id='label-container'></div>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8.3/dist/teachablemachine-pose.min.js"></script>
<script type="text/javascript">
    // More API functions here:
    // https://github.com/googlecreativelab/teachablemachine-community/tree/master/libraries/pose

    // the link to your model provided by Teachable Machine export panel
    const URL = './';
    let model, webcam, ctx, labelContainer, maxPredictions;

    async function init() {
        const modelURL = URL + '/model.json';
        const metadataURL = URL + '/metadata.json';
        
        // load the model and metadata
        // Refer to tmPose.loadFromFiles() in the API to support files from a file picker
        model = await tmPose.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        // Convenience function to setup a webcam
        const flip = true; // whether to flip the webcam
        webcam = new tmPose.Webcam(200, 200, flip); // width, height, flip
        await webcam.setup(); // request access to the webcam
        webcam.play();
        window.requestAnimationFrame(loop);

        // append/get elements to the DOM
        const canvas = document.getElementById('canvas');
        canvas.width = 200; canvas.height = 200;
        ctx = canvas.getContext('2d');
        labelContainer = document.getElementById('label-container');
        for (let i = 0; i < maxPredictions; i++) { // and class labels
            labelContainer.appendChild(document.createElement('div'));
        }
    }

    async function loop(timestamp) {
        webcam.update(); // update the webcam frame
        await predict();
        window.requestAnimationFrame(loop);
    }

    let lastLogTime = 0; // ë§ˆì§€ë§‰ìœ¼ë¡œ ë¡œê·¸ë¥¼ ì°ì€ ì‹œê°„ ê¸°ë¡

    async function predict() {
        // Prediction #1: run input through posenet
        // estimatePose can take in an image, video or canvas html element
        const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
        // Prediction 2: run input through teachable machine classification model
        const prediction = await model.predict(posenetOutput);

        // ë™ì‘ë³„ í™•ë¥ ì„ ê°ì²´ë¡œ ì €ì¥
        const predictionMap = {};

        // for (let i = 0; i < maxPredictions; i++) {
        //     const classPrediction =
        //         prediction[i].className + ': ' + prediction[i].probability.toFixed(2);
        //     labelContainer.childNodes[i].innerHTML = classPrediction;

        //     // prediction[i].className (ì§ì§„, ì¢ŒíšŒì „, ìš°íšŒì „) 
        //     // console.log(prediction[i].probability.toFixed(2))
        // }


        const now = Date.now();


        const poseToDriveCommand = {
            "ë¹ ë¥¸ ì§ì§„":    { angle: 0.0, speed: 1.0 },
            "ëŠë¦° ì§ì§„":    { angle: 0.0, speed: 0.5 },
            "ë¹ ë¥¸ ì¢ŒíšŒì „":  { angle: -1.0, speed: 1.0 },
            "ëŠë¦° ì¢ŒíšŒì „":  { angle: -1.0, speed: 0.5 },
            "ë¹ ë¥¸ ìš°íšŒì „":  { angle: 1.0, speed: 1.0 },
            "ëŠë¦° ìš°íšŒì „":  { angle: 1.0, speed: 0.5 }
        };

        if(now - lastLogTime > 1000) {

        // ê°€ì¥ í™•ë¥  ë†’ì€ í´ë˜ìŠ¤ ì„ íƒ
        const top = prediction.reduce((prev, current) => (
            prev.probability > current.probability ? prev : current
        ));

           if (top.probability >= 0.8 && poseToDriveCommand[top.className]) {
            const { angle, speed } = poseToDriveCommand[top.className];

            const data = {
                angle: -Math.max(-1, Math.min(1, angle)),
                throttle: -Math.max(-1, Math.min(1, speed)),
                max_speed: speed
            };

            console.log("ë³´ë‚´ëŠ” ë°ì´í„°:", JSON.stringify(data));

            fetch('https://192.168.1.2/api/manual_drive', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(data)
            })
            .then(res => res.text())  // ì‘ë‹µì´ JSON ì•„ë‹ ìˆ˜ë„ ìˆì–´
            .then(text => {
            console.log("âœ… ì„œë²„ ì‘ë‹µ ë³¸ë¬¸:", text);
            })
            .catch(err => console.error("âŒ ì˜¤ë¥˜:", err));
        }    

        for (let i = 0; i < maxPredictions; i++) {
                const label = prediction[i].className;
                const prob = prediction[i].probability;
                predictionMap[label] = prob;

                // UI í‘œì‹œ
                const classPrediction = label + ': ' + prob.toFixed(2);
                labelContainer.childNodes[i].innerHTML = classPrediction;

                // console.log("ğŸ” ì˜ˆì¸¡ ê²°ê³¼:", predictionMap);

                // ì˜ˆ: í™•ë¥ ì´ 0.8 ì´ìƒì¼ ë•Œë§Œ ë™ì‘ ì²˜ë¦¬
                if (prob >= 0.5) {
                    switch (label) {
                        case "ë¹ ë¥¸ ì§ì§„":
                            console.log("ğŸš€ ë¹ ë¥¸ ì§ì§„ ê°ì§€:", prob.toFixed(2));
                            // ë™ì‘ ì²˜ë¦¬ ì½”ë“œ
                            break;
                        case "ëŠë¦° ì§ì§„":
                            console.log("ğŸš¶ ëŠë¦° ì§ì§„ ê°ì§€:", prob.toFixed(2));
                            break;

                        case "ë¹ ë¥¸ ì¢ŒíšŒì „":
                            console.log("â†ªï¸ ë¹ ë¥¸ ì¢ŒíšŒì „ ê°ì§€:", prob.toFixed(2));
                            break;

                        case "ëŠë¦° ì¢ŒíšŒì „":
                            console.log("â†©ï¸ ëŠë¦° ì¢ŒíšŒì „ ê°ì§€:", prob.toFixed(2));
                            break;

                        case "ë¹ ë¥¸ ìš°íšŒì „":
                            console.log("â¡ï¸ ë¹ ë¥¸ ìš°íšŒì „ ê°ì§€:", prob.toFixed(2));
                            break;

                        case "ëŠë¦° ìš°íšŒì „":
                            console.log("â¬…ï¸ ëŠë¦° ìš°íšŒì „ ê°ì§€:", prob.toFixed(2));
                            break;

                        default:
                            console.log("ğŸ¤· ì•Œ ìˆ˜ ì—†ëŠ” ë™ì‘:", label, prob.toFixed(2));
                    }
                }
            }

               lastLogTime = now; // ë§ˆì§€ë§‰ ë¡œê·¸ ì‹œê°„ ê°±ì‹ 
        }

        updateProgressBars(predictionMap);

        // finally draw the poses
        drawPose(pose);

        console.log("ğŸ” ì˜ˆì¸¡ê°’ í™•ì¸:", predictionMap);

    }

    function drawPose(pose) {
        ctx.drawImage(webcam.canvas, 0, 0);
        // draw the keypoints and skeleton
        if (pose) {
            const minPartConfidence = 0.5;
            tmPose.drawKeypoints(pose.keypoints, minPartConfidence, ctx);
            tmPose.drawSkeleton(pose.keypoints, minPartConfidence, ctx);
        }
    }

    // ì‹¤ì‹œê°„ í”„ë¡œê·¸ë ˆìŠ¤ë°” ì—…ë°ì´íŠ¸
    function updateProgressBars(predictionMap) {
        const mapping = {
            "ë¹ ë¥¸ ì§ì§„": "progress-fast-straight",
            "ëŠë¦° ì§ì§„": "progress-slow-straight",
            "ë¹ ë¥¸ ì¢ŒíšŒì „": "progress-fast-left",
            "ëŠë¦° ì¢ŒíšŒì „": "progress-slow-left",
            "ë¹ ë¥¸ ìš°íšŒì „": "progress-fast-right",
            "ëŠë¦° ìš°íšŒì „": "progress-slow-right"
        };

        for (const [label, id] of Object.entries(mapping)) {
            const value = predictionMap[label] || 0;
            const percent = Math.round(value * 100);

            console.log("í¼ì„¼íŠ¸í™•ì¸")
            console.log(percent)

            const bar = document.getElementById(id);
            if (bar) {
            bar.style.width = `${percent}%`;
            bar.innerText = percent > 15 ? `${percent}%` : ""; // ë„ˆë¬´ ì¢ìœ¼ë©´ í…ìŠ¤íŠ¸ ìƒëµ
            }
        }
    }

    // const url = 'https://192.168.1.2/route?topic=/camera_pkg/display_mjpeg&width=480&height=360' 
    //     fetch(url, {
    //         method: 'GET',
    //         credentials: 'include',
    //             // headers: {
    //             //     // 'Authorization': 'Bearer YOUR_TOKEN',
    //             //     // ë˜ëŠ” í…ŒìŠ¤íŠ¸ìš© ì¿ í‚¤ë¥¼ ê°•ì œë¡œ ì¶”ê°€í•´ë³¼ ìˆ˜ë„ ìˆìŒ (ì¼ì‹œì  ë””ë²„ê¹… ìš©ë„)
    //             //     'Cookie': 'session_id=abc123'
    //             // }
    //     }).then(response => {

    //         console.log("ìŠ¤í…Œì´í„°ìŠ¤ í™•ì¸")
    //         console.log(response.status)
    //         if (response.ok) {
    //             console.log("ì„±ê³µ")
    //             console.log('Stream started successfully');
    //         } else {
    //             console.error('Error starting stream:', response.statusText);
    //             console.log("ì—ëŸ¬111")
    //         }
    //     }).catch(error => {
    //         console.log("ì—ëŸ¬222")
    //         console.error('Error:', error);
    //     });

</script>
</body>
</html>